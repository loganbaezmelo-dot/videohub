<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoHub</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { indigo: { 600: '#4f46e5', 700: '#4338ca' }, gray: { 950: '#030712' } } } }
        }
    </script>

    <!-- 2. REACT & BABEL (Globals) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. FIREBASE COMPAT LIBRARIES (Globals - The Unbreakable Way) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in-out { animation: fadeInOut 4s ease-in-out; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translateY(-20px); } 15%, 85% { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-950 min-h-screen text-gray-900 dark:text-white font-sans transition-colors duration-200">
    
    <!-- LOADING / ERROR FALLBACK -->
    <div id="root">
        <div style="display:flex;height:100vh;justify-content:center;align-items:center;flex-direction:column; color: #666;">
            <h1 style="font-size:24px; margin-bottom:10px;">Loading VideoHub...</h1>
            <p style="font-size:14px;">If this takes longer than 5 seconds, something is wrong.</p>
        </div>
    </div>

    <script type="text/babel">
        // --- GLOBAL ERROR HANDLER ---
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            root.innerHTML = `<div style="padding:20px; color:red; text-align:center;"><h1>CRASH DETECTED</h1><p>${message}</p><p>Line: ${lineno}</p></div>`;
        };

        // --- 1. DESTRUCTURE GLOBALS (No Imports!) ---
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        
        // Firebase Globals (Compat)
        const firebaseConfig = {
            apiKey: "AIzaSyBgMmLBi1N3gOEzQwVa9y94N_kQiieXlMM",
            authDomain: "reelstream-b730e.firebaseapp.com",
            projectId: "reelstream-b730e",
            storageBucket: "reelstream-b730e.firebasestorage.app",
            messagingSenderId: "1099473053212",
            appId: "1:1099473053212:web:5d98b4b26a7dcd95bb61d9",
            measurementId: "G-D8VSN8WDTC"
        };

        // Initialize Firebase (Compat style)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        const appId = firebaseConfig.appId;

        // --- ICONS (Inline SVGs to avoid import errors) ---
        const Icon = ({ d, className, onClick }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={d} />
            </svg>
        );
        const Icons = {
            Home: (props) => <Icon d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" {...props} />,
            Bytes: (props) => <Icon d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z" {...props} />, // Film icon approximation
            Upload: (props) => <Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12" {...props} />,
            User: (props) => <Icon d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" {...props} />,
            Trash: (props) => <Icon d="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" {...props} />,
            ThumbsUp: (props) => <Icon d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3" {...props} />,
            X: (props) => <Icon d="M18 6L6 18M6 6l12 12" {...props} />,
            Shield: (props) => <Icon d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" {...props} />,
            Phone: (props) => <Icon d="M12 14l9-5-9-5-9 5 9 5z M12 14l6.16-3.422a12.083 12.083 0 0 1 .665 6.479A11.952 11.952 0 0 0 12 20.055a11.952 11.952 0 0 0-6.824-2.998 12.078 12.078 0 0 1 .665-6.479L12 14z" {...props} />, // Layer icon sub
            Copy: (props) => <Icon d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2 M16 4h2a2 2 0 0 1 2 2v4 M21 14H11" {...props} /> // Copyish
        };

        // --- HELPERS ---
        const getDeviceInfo = () => {
            const ua = navigator.userAgent;
            return { name: /mobile/i.test(ua) ? 'Mobile' : 'Desktop', icon: 'device' };
        };

        const Message = ({ message }) => {
            if (!message) return null;
            const bg = message.type === 'error' ? 'bg-red-600' : 'bg-green-600';
            return <div className={`fixed top-5 left-1/2 -translate-x-1/2 z-[100] ${bg} text-white px-4 py-2 rounded shadow-lg`}>{message.text}</div>;
        };

        // --- MAIN APP LOGIC ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [view, setView] = useState('landing');
            const [msg, setMsg] = useState(null);
            const [videos, setVideos] = useState([]);
            const [following, setFollowing] = useState([]);
            const [watching, setWatching] = useState(null);
            const [homeFeed, setHomeFeed] = useState('all');
            const [search, setSearch] = useState('');
            const [viewChannel, setViewChannel] = useState(null);
            
            // Auth & Data
            useEffect(() => {
                // Google Redirect Result
                auth.getRedirectResult().then(res => {
                    if(res) { setMsg({text:"Logged in!", type:"success"}); setView('home'); }
                }).catch(e => setMsg({text:e.message, type:"error"}));

                // Auth State
                return auth.onAuthStateChanged(async (u) => {
                    if(u && !u.isAnonymous) {
                        setUser(u);
                        // User Doc
                        const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(u.uid);
                        userRef.onSnapshot(doc => {
                            if(doc.exists) setProfile(doc.data());
                            else userRef.set({ name: u.displayName, profilePictureUrl: u.photoURL });
                        });
                        // Following
                        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('subscribers')
                          .where('subscriberId', '==', u.uid)
                          .onSnapshot(snap => setFollowing(snap.docs.map(d => d.data().uploaderId)));
                        
                        // Device
                        const devId = localStorage.getItem('vh_dev') || Math.random().toString(36).substring(7);
                        localStorage.setItem('vh_dev', devId);
                        db.collection('artifacts').doc(appId).collection('users').doc(u.uid).collection('devices').doc(devId).set({
                            name: getDeviceInfo().name, lastActive: firebase.firestore.FieldValue.serverTimestamp()
                        }, {merge:true});
                        
                        // Redirect to home if landing
                        setView(v => v === 'landing' ? 'home' : v);
                    } else {
                        setUser(null);
                        if(u?.isAnonymous) setView(v => v === 'landing' ? 'home' : v);
                    }
                });
            }, []);

            // Videos
            useEffect(() => {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('videos')
                  .onSnapshot(s => setVideos(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0))));
            }, []);

            // Handlers
            const showMsg = (t, type='info') => { setMsg({text:t, type}); setTimeout(()=>setMsg(null), 3000); };
            const loginGoogle = () => auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
            const uploadVideo = async ({file, title, type}) => {
                if(!user) return showMsg("Login to upload", "error");
                // Simple validation
                if(type === 'byte') {
                    const vid = document.createElement('video');
                    vid.src = URL.createObjectURL(file);
                    await new Promise(r => vid.onloadedmetadata = r);
                    if(vid.videoWidth > vid.videoHeight) return showMsg("Bytes must be vertical", "error");
                    if(vid.duration > 180) return showMsg("Bytes < 3 mins", "error");
                }
                // Upload
                const ref = storage.ref(`content/${user.uid}/${Date.now()}_${file.name}`);
                await ref.put(file);
                const url = await ref.getDownloadURL();
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(type === 'byte' ? 'bytes' : 'videos').add({
                    title, videoUrl: url, uploaderId: user.uid, uploaderName: profile?.name || 'User', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showMsg("Uploaded!", "success"); setView('home');
            };

            // Components
            const BottomNav = () => (
                <div className="fixed bottom-0 w-full h-16 bg-white dark:bg-gray-900 border-t dark:border-gray-800 flex justify-around items-center z-50">
                    <div onClick={()=>setView('home')} className="flex flex-col items-center p-2"><Icons.Home className="w-6 h-6 text-gray-500"/></div>
                    <div onClick={()=>showMsg("Bytes soon")} className="flex flex-col items-center p-2"><Icons.Bytes className="w-6 h-6 text-gray-500"/></div>
                    {user && <div onClick={()=>setView('upload')} className="flex flex-col items-center p-2"><Icons.Upload className="w-6 h-6 text-gray-500"/></div>}
                    <div onClick={()=>user?setView('channel'):setView('landing')} className="flex flex-col items-center p-2"><Icons.User className="w-6 h-6 text-gray-500"/></div>
                </div>
            );

            const VideoGrid = ({list}) => (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 p-2 pb-20">
                    {list.map(v => (
                        <div key={v.id} className="bg-white dark:bg-gray-800 rounded overflow-hidden shadow" onClick={()=>{setWatching(v); setView('watch')}}>
                            <div className="h-40 bg-gray-200 flex items-center justify-center text-gray-500">Video Preview</div>
                            <div className="p-2"><h3 className="font-bold truncate">{v.title}</h3><p className="text-xs">{v.uploaderName}</p></div>
                        </div>
                    ))}
                </div>
            );

            const UploadView = () => {
                const [type, setType] = useState('video');
                const [title, setTitle] = useState('');
                const [file, setFile] = useState(null);
                const [loading, setLoading] = useState(false);
                const submit = async () => {
                    if(!file || !title) return;
                    setLoading(true);
                    await uploadVideo({file, title, type});
                    setLoading(false);
                };
                return (
                    <div className="p-4 max-w-md mx-auto mt-10">
                        <h2 className="text-2xl font-bold mb-4">Upload</h2>
                        <select className="w-full p-2 mb-4 bg-white dark:bg-gray-800 border rounded" value={type} onChange={e=>setType(e.target.value)}>
                            <option value="video">Video</option><option value="byte">Byte</option>
                        </select>
                        <input className="w-full p-2 mb-4 bg-white dark:bg-gray-800 border rounded" placeholder="Title" value={title} onChange={e=>setTitle(e.target.value)}/>
                        <input type="file" accept="video/*" className="mb-4" onChange={e=>setFile(e.target.files[0])} />
                        <button disabled={loading} onClick={submit} className="w-full p-2 bg-indigo-600 text-white rounded">{loading?'Uploading...':'Upload'}</button>
                    </div>
                )
            };

            const WatchScreen = () => {
                if(!watching) return null;
                return (
                    <div className="pb-20">
                        <div className="bg-black relative">
                            <video src={watching.videoUrl} controls autoPlay className="w-full max-h-[60vh]"></video>
                            <button onClick={()=>setView('home')} className="absolute top-4 left-4 bg-black/50 p-2 rounded-full text-white"><Icons.X className="w-5 h-5"/></button>
                        </div>
                        <div className="p-4">
                            <h1 className="text-xl font-bold">{watching.title}</h1>
                            <p className="text-sm text-gray-500">{watching.uploaderName}</p>
                            <div className="mt-4"><h3 className="font-bold">Comments</h3><p className="text-sm text-gray-400">Comments loading...</p></div>
                        </div>
                    </div>
                )
            };

            return (
                <div className="max-w-md mx-auto bg-gray-100 dark:bg-black min-h-screen shadow-xl relative overflow-hidden">
                    <Message message={msg} />
                    
                    {/* VIEWS */}
                    {view === 'landing' && (
                        <div className="flex flex-col items-center justify-center h-screen p-6 text-center">
                            <h1 className="text-4xl font-bold text-indigo-600 mb-4">VideoHub</h1>
                            <button onClick={loginGoogle} className="w-full py-3 bg-white text-gray-800 rounded shadow mb-3 font-bold">Google Login</button>
                            <button onClick={()=>{auth.signInAnonymously();}} className="text-gray-500 text-sm">Guest</button>
                        </div>
                    )}

                    {view === 'home' && (
                        <>
                            <div className="p-4 bg-white dark:bg-gray-900 shadow z-10 sticky top-0"><h1 className="text-xl font-bold text-indigo-600">VideoHub</h1></div>
                            <div className="flex p-2 gap-2"><button onClick={()=>setHomeFeed('all')} className={`flex-1 p-1 rounded ${homeFeed==='all'?'bg-indigo-600 text-white':'bg-gray-200'}`}>All</button><button onClick={()=>setHomeFeed('subs')} className={`flex-1 p-1 rounded ${homeFeed==='subs'?'bg-indigo-600 text-white':'bg-gray-200'}`}>Following</button></div>
                            <VideoGrid list={homeFeed==='all' ? videos : videos.filter(v => following.includes(v.uploaderId))} />
                        </>
                    )}

                    {view === 'upload' && <UploadView />}
                    {view === 'watch' && <WatchScreen />}
                    {view === 'channel' && <div className="p-4"><h1 className="text-2xl">My Channel</h1><button onClick={()=>auth.signOut().then(()=>setView('landing'))} className="text-red-500 mt-4">Logout</button></div>}

                    {view !== 'landing' && view !== 'watch' && <BottomNav />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


